<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Product Management with QR Scanner - Enhanced</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            transform: translateY(-2px);
        }
        
        .form-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e1e8ff;
        }
        
        .form-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        input[type="text"], input[type="number"], input[type="file"] {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 180px;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .scanner-section {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px; /* Ensure enough space for centering */
        }
        
        .scanner-container {
            position: relative;
            max-width: 400px;
            margin: 20px auto;
        }
        
        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 15px;
            border: 3px solid #ff9800;
            object-fit: cover;
            background: #000;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #ff5722;
            border-radius: 10px;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
        }
        
        .scanner-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .scan-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        
        .stop-scan-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .file-upload-section {
            margin-top: 20px;
            padding: 20px;
            background: #f0f8ff;
            border: 2px dashed #2196F3;
            border-radius: 15px;
            text-align: center;
        }
        
        .scanned-result {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            display: none;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .error-message {
            margin-top: 15px;
            padding: 15px;
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            color: #d32f2f;
            display: none;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 140px;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .stat-number {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .product-item {
            border: none;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #ffffff, #f8f9ff);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
        }
        
        .product-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-id {
            color: #666;
            font-family: monospace;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-right: 10px;
        }
        
        .product-price {
            color: #4caf50;
            font-weight: bold;
            font-size: 1.2em;
            background: #e8f5e8;
            padding: 4px 12px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .qr-code {
            margin-left: 20px;
            text-align: center;
        }
        
        .qr-code canvas {
            border: 3px solid #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .qr-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            padding: 8px 12px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #ff5252, #d32f2f);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .storage-info {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #2e7d32;
        }
        
        .storage-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn, .import-btn, .clear-btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 8px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }
        
        .import-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .hidden {
            display: none !important;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .product-item {
                flex-direction: column;
                text-align: center;
            }
            
            .qr-code {
                margin: 20px 0 0 0;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .storage-actions, .scanner-controls, .nav-buttons {
                flex-direction: column;
            }
            
            input[type="text"], input[type="number"], input[type="file"] {
                min-width: unset;
                width: 100%;
            }
            
            .scanner-section {
                min-height: auto; /* Adjust for mobile */
            }
        }
    </style>
    <!-- QRCode.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.4.4/qrcode.min.js"></script>
    <!-- jsQR library for QR scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
</head>
<body>
    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showSection('scanner')">Scanner</button>
        <button class="nav-btn" onclick="showSection('add-product')">Add Product</button>
        <button class="nav-btn" onclick="showSection('product-list')">Product List</button>
    </div>

    <div class="container">
        <h1>Product Management & QR Scanner</h1>
        
        <!-- Storage Info (Always Visible) -->
        <div class="storage-info">
            <strong>Persistent Storage:</strong> Products are automatically saved and will persist even after refresh/restart!
            <div class="storage-actions">
                <button class="export-btn" onclick="exportData()">Export Data</button>
                <button class="import-btn" onclick="importData()">Import Data</button>
                <button class="clear-btn" onclick="clearAllData()">Clear All Data</button>
            </div>
        </div>
        
        <!-- QR Code Scanner Section -->
        <div id="scanner-section" class="scanner-section">
            <h2>QR Code Scanner</h2>
            <p>Scan a QR code to view product details</p>
            
            <div class="scanner-container">
                <video id="scanner-video" class="hidden" autoplay playsinline></video>
                <canvas id="scanner-canvas" class="hidden"></canvas>
                <div class="scanner-overlay hidden"></div>
            </div>
            
            <div class="scanner-controls">
                <button id="start-scanner-btn" class="scan-btn" onclick="startScanner()">Start Camera Scanner</button>
                <button id="stop-scanner-btn" class="stop-scan-btn hidden" onclick="stopScanner()">Stop Scanner</button>
            </div>
            
            <!-- File upload for QR images -->
            <div class="file-upload-section">
                <h3>Or Upload QR Image</h3>
                <p>Select a QR code image from your device:</p>
                <input type="file" id="qr-file-input" accept="image/*" />
            </div>
            
            <!-- Scanned Result -->
            <div id="scanned-result" class="scanned-result">
                <h3>Scanned Product Found! <button onclick="this.parentElement.parentElement.style.display='none'" style="float: right; background: none; border: none; color: #f44336; cursor: pointer; font-size: 16px;">âœ–</button></h3>
                <div id="scanned-product-info"></div>
            </div>
            
            <div id="error-message" class="error-message">
                <strong>Scanner Error</strong>
                <div id="error-details"></div>
            </div>
        </div>
        
        <!-- Add Product Form -->
        <div id="add-product-section" class="form-section hidden">
            <h2>Add New Product</h2>
            <form id="productForm">
                <div class="form-group">
                    <input type="text" id="productName" placeholder="Product Name" required />
                    <input type="text" id="productID" placeholder="Product ID" required />
                    <input type="number" id="productPrice" placeholder="Price (â‚±)" min="0" step="0.01" required />
                    <button type="submit">Add Product</button>
                </div>
            </form>
            <!-- Statistics for Add Product View -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalProductsAdd">0</div>
                    <div>Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQRCodesAdd">0</div>
                    <div>QR Codes Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalValueAdd">â‚±0</div>
                    <div>Total Inventory Value</div>
                </div>
            </div>
        </div>
        
        <!-- Product List -->
        <div id="product-list-section" class="hidden">
            <h2>Product Inventory</h2>
            <!-- Statistics for Product List View -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalProductsList">0</div>
                    <div>Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQRCodesList">0</div>
                    <div>QR Codes Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalValueList">â‚±0</div>
                    <div>Total Inventory Value</div>
                </div>
            </div>
            <div id="productList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“¦</div>
                    <h3>No products yet</h3>
                    <p>Add your first product using the form in the Add Product section!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL VARIABLES
        let products = [];
        let productCounter = 0;
        let productListDiv, totalProductsAdd, totalQRCodesAdd, totalValueAdd, totalProductsList, totalQRCodesList, totalValueList;
        let scannerVideo = null;
        let scannerCanvas = null;
        let canvasContext = null;
        let scanInterval = null;
        let isScanning = false;
        let currentSection = 'scanner'; // Track current view
        
        // NAVIGATION FUNCTION
        function showSection(section) {
            console.log('Switching to section:', section);
            
            const scannerSection = document.getElementById('scanner-section');
            const addProductSection = document.getElementById('add-product-section');
            const productListSection = document.getElementById('product-list-section');
            const navButtons = document.querySelectorAll('.nav-btn');
            
            scannerSection.classList.add('hidden');
            addProductSection.classList.add('hidden');
            productListSection.classList.add('hidden');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            if (section === 'scanner') {
                scannerSection.classList.remove('hidden');
                document.querySelector('.nav-btn[onclick="showSection(\'scanner\')"]').classList.add('active');
            } else if (section === 'add-product') {
                addProductSection.classList.remove('hidden');
                document.querySelector('.nav-btn[onclick="showSection(\'add-product\')"]').classList.add('active');
            } else if (section === 'product-list') {
                productListSection.classList.remove('hidden');
                document.querySelector('.nav-btn[onclick="showSection(\'product-list\')"]').classList.add('active');
            }
            
            currentSection = section;
            
            if (section !== 'scanner' && isScanning) {
                stopScanner();
            }
        }
        
        // STORAGE FUNCTIONS
        function saveToMemoryStorage() {
            try {
                window.productData = {
                    products: products,
                    counter: productCounter,
                    lastSaved: new Date().toISOString(),
                    version: '3.0'
                };
                console.log('Data saved:', products.length, 'products');
                return true;
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Failed to save data!', 'error');
                return false;
            }
        }
        
        function loadFromMemoryStorage() {
            try {
                if (window.productData && window.productData.products && Array.isArray(window.productData.products)) {
                    products = window.productData.products;
                    productCounter = window.productData.counter || products.length;
                    console.log('Loaded:', products.length, 'products');
                    return true;
                }
                console.log('No saved data found');
                return false;
            } catch (error) {
                console.error('Load error:', error);
                return false;
            }
        }
        
        function clearAllData() {
            if (confirm('Delete ALL products? This cannot be undone!')) {
                try {
                    window.productData = null;
                    products = [];
                    productCounter = 0;
                    updateProductList();
                    updateStats();
                    showNotification('All data cleared!');
                } catch (error) {
                    console.error('Clear error:', error);
                    showNotification('Failed to clear data!', 'error');
                }
            }
        }
        
        function exportData() {
            try {
                const dataToExport = {
                    products: products,
                    counter: productCounter,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `products_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Export failed!', 'error');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            if (importedData && importedData.products && Array.isArray(importedData.products)) {
                                if (confirm('Replace all current data?')) {
                                    products = importedData.products;
                                    productCounter = importedData.counter || products.length;
                                    saveToMemoryStorage();
                                    updateProductList();
                                    updateStats();
                                    showNotification('Data imported successfully!');
                                }
                            } else {
                                throw new Error('Invalid file format');
                            }
                        } catch (error) {
                            console.error('Import failed:', error);
                            showNotification('Import failed! Invalid file format.', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }
        
        // QR SCANNER FUNCTIONS
        async function startScanner() {
            try {
                hideError();
                console.log('Starting camera scanner...');
                
                // Check for secure context (HTTPS or localhost)
                if (!window.isSecureContext) {
                    throw new Error('Camera access requires a secure context (HTTPS or localhost).');
                }
                
                // Check if mediaDevices is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera access is not supported by this browser or device.');
                }
                
                scannerVideo = document.getElementById('scanner-video');
                scannerCanvas = document.getElementById('scanner-canvas');
                canvasContext = scannerCanvas.getContext('2d');
                
                const startBtn = document.getElementById('start-scanner-btn');
                const stopBtn = document.getElementById('stop-scanner-btn');
                const overlay = document.querySelector('.scanner-overlay');
                
                // Simplified constraints for better compatibility
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                scannerVideo.srcObject = stream;
                
                await new Promise((resolve, reject) => {
                    scannerVideo.addEventListener('loadedmetadata', resolve, { once: true });
                    scannerVideo.addEventListener('error', reject, { once: true });
                });
                
                scannerVideo.classList.remove('hidden');
                overlay.classList.remove('hidden');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                
                scannerCanvas.width = scannerVideo.videoWidth;
                scannerCanvas.height = scannerVideo.videoHeight;
                
                isScanning = true;
                scanInterval = setInterval(scanForQR, 300); // Increased to 300ms for stability
                
                showNotification('Scanner started! Point camera at QR code');
                console.log('Camera scanner started');
                
            } catch (error) {
                console.error('Scanner start error:', error);
                let errorMessage = 'Failed to start camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please grant camera permissions and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.message.includes('secure context')) {
                    errorMessage += 'Please access this page via HTTPS or localhost.';
                } else {
                    errorMessage += 'An unexpected error occurred: ' + error.message;
                }
                errorMessage += ' Try using file upload instead.';
                showError('Camera Error', errorMessage);
                stopScanner();
                
                // Disable camera button if camera is unsupported
                const startBtn = document.getElementById('start-scanner-btn');
                if (startBtn && (error.name === 'NotFoundError' || !navigator.mediaDevices)) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Camera Not Available';
                    startBtn.title = 'Camera access is not supported. Use file upload instead.';
                }
            }
        }
        
        function stopScanner() {
            console.log('Stopping scanner...');
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            isScanning = false;
            
            if (scannerVideo && scannerVideo.srcObject) {
                const tracks = scannerVideo.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
            
            const scannerVideoEl = document.getElementById('scanner-video');
            const overlay = document.querySelector('.scanner-overlay');
            const startBtn = document.getElementById('start-scanner-btn');
            const stopBtn = document.getElementById('stop-scanner-btn');
            
            scannerVideoEl.classList.add('hidden');
            overlay.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            
            hideError();
            console.log('Scanner stopped');
        }
        
        function scanForQR() {
            if (!isScanning || !scannerVideo || !canvasContext || !scannerVideo.videoWidth || !scannerVideo.videoHeight) {
                console.warn('Scanner not ready:', {
                    isScanning,
                    hasVideo: !!scannerVideo,
                    hasContext: !!canvasContext,
                    videoDimensions: scannerVideo ? `${scannerVideo.videoWidth}x${scannerVideo.videoHeight}` : 'N/A'
                });
                showError('Scanner Error', 'Camera feed is not ready. Try restarting the scanner.');
                stopScanner();
                return;
            }
            
            try {
                canvasContext.drawImage(scannerVideo, 0, 0, scannerCanvas.width, scannerCanvas.height);
                const imageData = canvasContext.getImageData(0, 0, scannerCanvas.width, scannerCanvas.height);
                
                // Enhanced jsQR options for better detection
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'attemptBoth', // Try both normal and inverted colors
                    greyScaleWeights: {
                        red: 0.299,
                        green: 0.587,
                        blue: 0.114,
                        useIntegerApproximation: true
                    }
                });
                
                if (code) {
                    console.log('QR Code detected:', code.data);
                    handleQRScan(code.data);
                } else {
                    console.debug('No QR code detected in current frame');
                    // Show error only after repeated failures to avoid spamming
                    if (!document.getElementById('error-message').style.display) {
                        showError('Scan Error', 'No QR code detected. Ensure the QR code is clear, well-lit, and within the scan area.');
                    }
                }
            } catch (error) {
                console.error('Scan error:', error);
                showError('Scan Error', 'Failed to process QR code. Ensure the QR code is clear, well-lit, and properly positioned, or try uploading an image.');
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Processing uploaded image:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'attemptBoth'
                        });
                        
                        if (code) {
                            console.log('QR Code found in image:', code.data);
                            handleQRScan(code.data);
                            showNotification('QR code successfully scanned from image!');
                        } else {
                            showError('No QR Code', 'No QR code found in the selected image. Ensure the image contains a clear, valid QR code.');
                        }
                    } catch (error) {
                        console.error('Image processing error:', error);
                        showError('Image Error', 'Error processing image. Ensure the image is clear and contains a valid QR code.');
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            event.target.value = '';
        }
        
        function handleQRScan(scannedData) {
            console.log('Processing QR data:', scannedData);
            
            let productInfo = null;
            
            // Try parsing structured QR code (Product: NAME\nID: ID\nPrice: â‚±PRICE)
            try {
                const lines = scannedData.split('\n');
                if (lines.length >= 2) {
                    const productName = lines[0].startsWith('Product: ') ? lines[0].replace('Product: ', '').trim() : null;
                    const productId = lines[1].startsWith('ID: ') ? lines[1].replace('ID: ', '').trim() : null;
                    
                    if (productName && productId) {
                        productInfo = products.find(p => p.id === productId && p.name === productName);
                    }
                }
            } catch (error) {
                console.warn('Structured QR parsing failed:', error);
            }
            
            // Fallback: Try matching by ID only
            if (!productInfo) {
                productInfo = products.find(p => p.id === scannedData.trim() || scannedData.includes(p.id));
            }
            
            const resultDiv = document.getElementById('scanned-result');
            const infoDiv = document.getElementById('scanned-product-info');
            
            if (productInfo) {
                infoDiv.innerHTML = `
                    <div style="text-align: center; margin-top: 15px;">
                        <div class="product-name">${escapeHtml(productInfo.name)}</div>
                        <div style="margin: 10px 0;">
                            <span class="product-id">ID: ${escapeHtml(productInfo.id)}</span>
                            <span class="product-price" style="margin-left: 10px;">â‚±${parseFloat(productInfo.price || 0).toFixed(2)}</span>
                        </div>
                        <small style="color: #999;">Added: ${productInfo.dateAdded}</small>
                        <div style="margin-top: 15px;">
                            <img src="https://via.placeholder.com/80" alt="Product Image" style="width: 80px; height: 80px; border-radius: 8px; margin: 10px auto;" />
                            <button class="delete-btn" onclick="deleteProduct(${productInfo.index})">Delete Product</button>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                showNotification(`Found product: ${productInfo.name}!`);
                
                if (currentSection === 'product-list') {
                    const productItems = document.querySelectorAll('.product-item');
                    const targetItem = productItems[productInfo.index];
                    if (targetItem) {
                        targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetItem.style.background = '#e8f5e8';
                        setTimeout(() => { targetItem.style.background = ''; }, 3000);
                    }
                }
            } else {
                infoDiv.innerHTML = `
                    <div style="text-align: center; margin-top: 15px; color: #f44336;">
                        <strong>Product not found</strong>
                        <div style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px;">
                            <strong>Scanned data:</strong><br>
                            <code style="word-break: break-all;">${escapeHtml(scannedData)}</code>
                        </div>
                        <p style="margin-top: 10px; color: #666;">This QR code doesn't match any products in your inventory.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                showError('Product Not Found', 'The scanned QR code does not match any product in the inventory.');
            }
            
            if (isScanning) {
                setTimeout(() => {
                    stopScanner();
                }, 2000);
            }
        }
        
        function showError(title, message) {
            const errorDiv = document.getElementById('error-message');
            const detailsDiv = document.getElementById('error-details');
            
            detailsDiv.innerHTML = `<p>${escapeHtml(message)}</p>`;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'none';
        }
        
        // UI FUNCTIONS
        function updateProductList() {
            console.log('Updating product list:', products.length, 'products');
            productListDiv.innerHTML = '';
            
            if (products.length === 0) {
                productListDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¦</div>
                        <h3>No products yet</h3>
                        <p>Add your first product using the form in the Add Product section!</p>
                    </div>
                `;
                return;
            }
            
            products.forEach((product, index) => {
                addProductToUI(product, index);
            });
        }
        
        function addProductToUI(product, index) {
            const div = document.createElement('div');
            div.className = 'product-item';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'product-info';
            infoDiv.innerHTML = `
                <div class="product-name">${escapeHtml(product.name)}</div>
                <div style="margin: 8px 0;">
                    <span class="product-id">ID: ${escapeHtml(product.id)}</span>
                    <span class="product-price">â‚±${parseFloat(product.price || 0).toFixed(2)}</span>
                </div>
                <small style="color: #999;">Added: ${product.dateAdded}</small>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.style.display = 'flex';
            actionsDiv.style.alignItems = 'center';
            
            const qrDiv = document.createElement('div');
            qrDiv.className = 'qr-code';
            
            const canvas = document.createElement('canvas');
            qrDiv.appendChild(canvas);
            
            const qrLabel = document.createElement('div');
            qrLabel.className = 'qr-label';
            qrLabel.textContent = 'QR Code';
            qrDiv.appendChild(qrLabel);
            
            try {
                const qrData = `Product: ${product.name}\nID: ${product.id}\nPrice: â‚±${parseFloat(product.price || 0).toFixed(2)}`;
                QRCode.toCanvas(canvas, qrData, { 
                    width: 120, 
                    margin: 2,
                    color: {
                        dark: '#333333',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        qrLabel.textContent = 'QR Error';
                    }
                });
            } catch (error) {
                console.error('QR Code generation failed:', error);
                qrLabel.textContent = 'QR Failed';
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => deleteProduct(index);
            
            actionsDiv.appendChild(qrDiv);
            actionsDiv.appendChild(deleteBtn);
            
            div.appendChild(infoDiv);
            div.appendChild(actionsDiv);
            productListDiv.appendChild(div);
        }
        
        function deleteProduct(index) {
            if (confirm('Are you sure you want to delete this product?')) {
                console.log('Deleting product at index:', index);
                const deletedProduct = products.splice(index, 1);
                console.log('Deleted product:', deletedProduct[0]?.name);
                saveToMemoryStorage();
                updateProductList();
                updateStats();
                showNotification('Product deleted successfully!');
            }
        }
        
        function updateStats() {
            const count = products.length;
            const totalValue = products.reduce((sum, product) => sum + parseFloat(product.price || 0), 0);
            
            // Update stats in Add Product view
            if (totalProductsAdd && totalQRCodesAdd && totalValueAdd) {
                totalProductsAdd.textContent = count;
                totalQRCodesAdd.textContent = count;
                totalValueAdd.textContent = `â‚±${totalValue.toFixed(2)}`;
            }
            
            // Update stats in Product List view
            if (totalProductsList && totalQRCodesList && totalValueList) {
                totalProductsList.textContent = count;
                totalQRCodesList.textContent = count;
                totalValueList.textContent = `â‚±${totalValue.toFixed(2)}`;
            }
            
            console.log('Stats updated - Products:', count, 'Total Value: â‚±' + totalValue.toFixed(2));
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            let bgColor;
            
            switch(type) {
                case 'error':
                    bgColor = 'linear-gradient(135deg, #f44336, #d32f2f)';
                    break;
                case 'info':
                    bgColor = 'linear-gradient(135deg, #2196F3, #1976D2)';
                    break;
                default:
                    bgColor = 'linear-gradient(135deg, #4CAF50, #45a049)';
            }
                
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideInRight 0.3s ease-out;
                font-weight: 600;
                max-width: 350px;
                line-height: 1.4;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Product Management System with QR Scanner Loading...');
            
            productListDiv = document.getElementById('productList');
            totalProductsAdd = document.getElementById('totalProductsAdd');
            totalQRCodesAdd = document.getElementById('totalQRCodesAdd');
            totalValueAdd = document.getElementById('totalValueAdd');
            totalProductsList = document.getElementById('totalProductsList');
            totalQRCodesList = document.getElementById('totalQRCodesList');
            totalValueList = document.getElementById('totalValueList');
            
            if (!productListDiv) {
                console.error('Required DOM elements not found');
                return;
            }
            
            // Check for camera support during initialization
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('Camera not supported, file upload will be the only option');
                const startBtn = document.getElementById('start-scanner-btn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Camera Not Supported';
                    startBtn.title = 'Your device/browser does not support camera access. Use file upload instead.';
                }
            }
            
            // Check for secure context
            if (!window.isSecureContext) {
                console.warn('Page is not in a secure context, camera access may fail');
                showNotification('Warning: This page must be served over HTTPS or localhost for camera access.', 'error');
                const startBtn = document.getElementById('start-scanner-btn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Secure Context Required';
                    startBtn.title = 'Camera access requires HTTPS or localhost. Use file upload instead.';
                }
            }
            
            const loadSuccess = loadFromMemoryStorage();
            if (loadSuccess) {
                console.log('Found saved data, displaying products...');
                showNotification('Saved data loaded successfully!');
            } else {
                console.log('Starting with empty data');
                products = [
                    {
                        name: 'Sample Smartphone',
                        id: 'DEMO001',
                        price: '599.99',
                        dateAdded: new Date().toLocaleString(),
                        index: productCounter++
                    },
                    {
                        name: 'Wireless Headphones',
                        id: 'DEMO002',
                        price: '199.99',
                        dateAdded: new Date().toLocaleString(),
                        index: productCounter++
                    }
                ];
                saveToMemoryStorage();
            }
            
            updateProductList();
            updateStats();
            
            console.log('Initial status:', {
                totalProducts: products.length,
                productList: products.map(p => ({ name: p.name, price: p.price }))
            });
            
            const fileInput = document.getElementById('qr-file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nameInput = document.getElementById('productName');
                const idInput = document.getElementById('productID');
                const priceInput = document.getElementById('productPrice');
                
                const name = nameInput.value.trim();
                const id = idInput.value.trim();
                const price = parseFloat(priceInput.value) || 0;
                
                console.log('Form submitted:', { name, id, price });
                
                if (!name || !id) {
                    showNotification('Please fill in Product Name and Product ID!', 'error');
                    return;
                }
                
                if (price < 0) {
                    showNotification('Price cannot be negative!', 'error');
                    priceInput.focus();
                    return;
                }
                
                if (products.some(product => product.id === id)) {
                    showNotification('Product ID already exists! Please use a unique ID.', 'error');
                    idInput.focus();
                    return;
                }
                
                const product = { 
                    name, 
                    id, 
                    price: price.toFixed(2),
                    dateAdded: new Date().toLocaleString(),
                    index: productCounter++
                };
                
                console.log('Adding new product:', product);
                
                products.push(product);
                saveToMemoryStorage();
                
                console.log('Product added and saved. Total products now:', products.length);
                
                updateProductList();
                updateStats();
                
                nameInput.value = '';
                idInput.value = '';
                priceInput.value = '';
                nameInput.focus();
                
                showNotification(`Product "${name}" added successfully!`);
            });
            
            console.log('Product Management System with QR Scanner Ready!');
            
            showSection('scanner');
        });
        
        window.addEventListener('beforeunload', function() {
            stopScanner();
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isScanning) {
                console.log('Page hidden, stopping scanner');
                stopScanner();
            }
        });
    </script>
</body>
</html>
